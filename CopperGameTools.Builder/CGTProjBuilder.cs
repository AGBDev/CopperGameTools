namespace CopperGameTools.Builder;

public class CGTProjBuilder
{
    public CGTProjFile ProjFile { get; }


    public CGTProjBuilder(CGTProjFile cgtProjFile)
    {
        ProjFile = cgtProjFile;
    }

    public CGTProjBuilderResult Build()
    {
        if (ProjFile == null || ProjFile.SourceFile.DirectoryName == null) return new CGTProjBuilderResult(CGTProjBuilderResultType.FailedNoErrors);

        CGTProjFileCheckResult check = ProjFile.FileCheck();
        foreach (var error in check.ResultErrors)
            if (error.IsCritical)
                return new CGTProjBuilderResult(CGTProjBuilderResultType.FailedWithErrors);

        string projectName = ProjFile.KeyGet("project.name");
        string sourceDir = Path.Combine(ProjFile.SourceFile.DirectoryName,ProjFile.KeyGet("project.src.dir"));
        string sourceOut = ProjFile.KeyGet("project.src.out");
        string outDir = Path.Combine(ProjFile.SourceFile.DirectoryName, ProjFile.KeyGet("project.out.dir"));
        string mainFile = sourceDir + ProjFile.KeyGet("project.src.main");

        string[] argsList = Array.Empty<string>();

        if (ProjFile.KeyGet("project.src.args") != "")
        {
            Console.WriteLine("Collection args...");
            argsList = ProjFile.KeyGet("project.src.args").Split(" ", StringSplitOptions.RemoveEmptyEntries);
        }

        if (sourceDir == null || outDir == null) return new CGTProjBuilderResult(CGTProjBuilderResultType.FailedWithErrors);

        List<string> listedSourceFiles = (Directory.GetFiles(sourceDir, "*.js", SearchOption.AllDirectories)).ToList();

        string to_write = $"// FILE GENERATED BY COPPER GAME TOOLS PROJECT BUILDER//\n";

        to_write += $"// KEYS FROM {ProjFile.SourceFile.Name}\n";
        foreach (var key in ProjFile.FileKeys)
        {
            to_write += $"ccbSetCopperCubeVariable('{key.Key}','{key.Value}');\n";
        }

        to_write += $"// CODE FROM {sourceDir}\n";
        foreach (var file in listedSourceFiles)
        {
            if (file == mainFile) continue;
            to_write += $"{File.ReadAllText(file)}\n";
        }

        to_write += File.ReadAllText(mainFile);

        to_write += "Main(ccbGetCopperCubeVariable('project.src.args').split(' '));";

        if (!Directory.Exists(outDir))
            Directory.CreateDirectory(outDir);
        File.WriteAllText(outDir + sourceOut + ".js", to_write);
        Console.WriteLine("Done writing " + sourceOut + ".js.");

        Console.WriteLine("Packing content folder...");
        var folder = ProjFile.KeyGet("project.externalres.dir");
        if (folder != "")
        {
            ContentPacker.ContentPacker.Pack(Path.GetFullPath(folder), projectName.ToLower());
        }
        return check.ResultErrors.Count > 0 ? new CGTProjBuilderResult(CGTProjBuilderResultType.DoneWithErrors) : 
            new CGTProjBuilderResult(CGTProjBuilderResultType.DoneNoErrors);
    }
}

public class CGTProjBuilderResult
{
    public CGTProjBuilderResult(CGTProjBuilderResultType cgtProjBuilderResultType)
    {
        ResultType = cgtProjBuilderResultType;
    }

    public CGTProjBuilderResultType ResultType { get; }
}

public enum CGTProjBuilderResultType
{
    DoneNoErrors,
    DoneWithErrors,
    FailedNoErrors,
    FailedWithErrors
}
